<div class="user-approval-page">

  <!-- HEADER -->
  <div class="header">
    <h2>User Approval</h2>
    <p>Approve users first, then assign their access role</p>

    <button
      mat-stroked-button
      color="primary"
      (click)="togglePendingFilter()">
      {{ showPendingOnly ? 'Show All Users' : 'Show Pending Only' }}
    </button>
  </div>

  <!-- TABLE -->
  <div class="table-wrapper" *ngIf="!loading">

    <table mat-table [dataSource]="dataSource" class="mat-elevation-z4">

      <!-- USERNAME -->
      <ng-container matColumnDef="userName">
        <th mat-header-cell *matHeaderCellDef>Username</th>
        <td mat-cell *matCellDef="let user">
          {{ user.userName }}
        </td>
      </ng-container>

      <!-- EMAIL -->
      <ng-container matColumnDef="email">
        <th mat-header-cell *matHeaderCellDef>Email</th>
        <td mat-cell *matCellDef="let user">
          {{ user.email }}
        </td>
      </ng-container>

      <!-- REGISTERED -->
      <ng-container matColumnDef="registeredOn">
        <th mat-header-cell *matHeaderCellDef>Registered On</th>
        <td mat-cell *matCellDef="let user">
          {{ user.registeredOn | date:'medium' }}
        </td>
      </ng-container>

      <!-- STATUS -->
      <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef>Status</th>
        <td mat-cell *matCellDef="let user">
          <span
            class="status"
            [ngClass]="user.isApproved ? 'approved' : 'pending'">
            {{ user.isApproved ? 'Approved' : 'Pending' }}
          </span>
        </td>
      </ng-container>

      <!-- ROLE -->
      <ng-container matColumnDef="role">
        <th mat-header-cell *matHeaderCellDef>Role</th>
        <td mat-cell *matCellDef="let user">
          {{ user.roles?.length ? user.roles[0] : '-' }}
        </td>
      </ng-container>

      <!-- ACTIONS -->
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef>Actions</th>

        <td mat-cell *matCellDef="let user">

          <!-- APPROVE -->
          <button
            *ngIf="!user.isApproved"
            mat-raised-button
            color="primary"
            (click)="approve(user.id)">
            Approve
          </button>

          <!-- ASSIGN ROLE -->
          <div
            class="assign-container"
            *ngIf="user.isApproved && (!user.roles || user.roles.length === 0)">

            <mat-form-field appearance="outline">
              <mat-select
                placeholder="Select role"
                [(ngModel)]="selectedRoles[user.id]">
                <mat-option *ngFor="let r of roles" [value]="r">
                  {{ r }}
                </mat-option>
              </mat-select>
            </mat-form-field>

            <button
              mat-raised-button
              color="accent"
              [disabled]="!selectedRoles[user.id]"
              (click)="assignRole(user.id)">
              Assign
            </button>

          </div>

          <!-- LOCKED -->
          <span
            *ngIf="user.isApproved && user.roles?.length"
            class="locked">
            Role Locked
          </span>

        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>

    </table>

    <!-- PAGINATION -->
    <mat-paginator
      [pageSize]="5"
      [pageSizeOptions]="[5, 10, 20]"
      showFirstLastButtons>
    </mat-paginator>

  </div>

  <!-- LOADING -->
  <div class="loading" *ngIf="loading">
    <mat-spinner diameter="40"></mat-spinner>
    <p>Loading users...</p>
  </div>

</div>
